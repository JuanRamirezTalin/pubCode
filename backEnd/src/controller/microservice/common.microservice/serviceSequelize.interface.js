/* ----------------------------------------------------------------------------
  Purpose: interface for microservice
	        { BaseExtend, middlewares, patron }
					token.doValidApi/doValid
  --------------------- -------------------------------------------------------
  20220609 v_01.00 JRT: Create
  -----------------------------------------------------------------------------
  */ "use strict";const request=require("express")["request"],{Sequelize,Op}=require("sequelize"),{BaseExtend,middlewares,patron}=require("../..");class ServiceInterface extends BaseExtend{constructor(t=0,e,s,r,i,a,o,n,h,c,l,u,d,E,m,g){super(),this.doStartMS("ServiceInterface")}async msConnect(t){let e=t.password;return-1===e.indexOf("$$")&&-1===e.indexOf("%%")&&-1===e.indexOf("$%")||(t.password=""),!await this.isConnect(t)||(await this.doTest(),this.msIsError())}async isConnect(t){this.setMethod("isConnect"),this.useORM=await patron.orm.doConexion();t=await this.useORM.isConfig(t);return t||this.msSet_ErrorOcurrent("[i] useORM.isConfig",this.useORM.getError()),t}async doTest(){await this.useORM.doTestDB()||this.msSet_ErrorOcurrent("[i] useORM.doTest",this.useORM.getError())}async doCloseDB(){await this.useORM.doCloseDB()}async doModel(t){let e=null,s=this._path||__dirname;s=s.concat("/").concat(t);try{var r=await this.getORM();e=await require(s)(r,Sequelize)}catch(t){for(;!this.msIsError()&&(this.msSet_ErrorOcurrent("doModel","Modelo Incorrect"),0););}return e}async doCreateMS(t){var e;try{const s=await this.doModel(this.MODEL_FILE);if(this.msIsError())return;e=await s.create(t),await this.doCloseDB(),await this.msDoValidResult(e),this.msIsError()||this.msSet_Message(200,"DO-CREATE","OK")}catch(t){for(;!this.msIsError()&&(this.msSet_ErrorOcurrent("doCreate-Modelo Incorrect",t),0););}this.msSleep(1e3)}async doUpdateMS(t,e){var s;try{const r=await this.doModel(this.MODEL_FILE);if(this.msIsError())return;s=await r.update(t,{where:e}),await this.doCloseDB(),await this.msDoValidResult(s),this.msIsError()||this.msSet_Message(200,"DO-UPDATE","OK")}catch(t){for(;!this.msIsError()&&(this.msSet_ErrorOcurrent("doUpdate-Modelo Incorrect",t),0););}this.msSleep(1e3)}async doDeleteMS(){const e="doDeleteMS";try{let t=await this.doModel(this.MODEL_FILE);if(this.msIsError())return;await t.destroy({where:this.WHERE}).then(t=>{t<=0?this.msSet_ErrorOcurrent(e,"Record No Found"):this.msSet_Message(200,"Record Delete")}),await this.doCloseDB()}catch(t){for(;!this.msIsError()&&(await this.msSet_ErrorOcurrent(e,t),0););}this.msSleep(1e3)}async doQueryFindOne(t,e){let s=null;try{const r=await this.doModel(t);s=await r.findOne(e).catch(t=>{for(;!this.msIsError()&&("ECONNREFUSED"!==t.parent.code&&"-4078"!==t.parent.errno||this.msSet_ErrorOcurrent("doQueryFindOne",t.message),this.msSet_ErrorOcurrent("doQueryFindOne",t.message),0););}),await this.doCloseDB(),await this.msDoValidResult(s)}catch(t){for(;!this.msIsError()&&(this.msSet_ErrorOcurrent("doQueryFindOne-Modelo Incorrect",t),0););}return this.msSleep(1e3),s}async doQueryFindAll(t,e){let s=null;try{const r=await this.doModel(t);s=await r.findAll(e).catch(t=>{for(;!this.msIsError()&&("ECONNREFUSED"!==t.parent.code&&"-4078"!==t.parent.errno||this.msSet_ErrorOcurrent("doQueryFindAll",t.message),this.msSet_ErrorOcurrent("doQueryFindAll",t.message),0););}),await this.doCloseDB(),await this.msDoValidResult(s)}catch(t){for(;!this.msIsError()&&(this.msSet_ErrorOcurrent("doQueryFindAll-Modelo Incorrect",t),0););}return this.msSleep(1e3),s}async doQueryFindCountAll(t,e){let s=null;try{const r=await this.doModel(t);s=await r.findAndCountAll(e).catch(t=>{for(;!this.msIsError()&&("ECONNREFUSED"!==t.parent.code&&"-4078"!==t.parent.errno||this.msSet_ErrorOcurrent("doQueryFindCountAll",t.message),this.msSet_ErrorOcurrent("doQueryFindCountAll",t.message),0););}),await this.doCloseDB(),await this.msDoValidResult(s)}catch(t){for(;!this.msIsError()&&(this.msSet_ErrorOcurrent("doQueryFindCountAll-Modelo Incorrect",t),0););}return this.msSleep(1e3),s}doPagination(t){var{count:t,rows:e}=t,s=this._PAGINATION_PAGE+1;return{totalPage:Math.ceil(t/this._PAGINATION_SIZE),currentPage:s,totalItems:t,pageItems:this._PAGINATION_SIZE,rows:e}}getPagination(){return{LIMIT:this._PAGINATION_SIZE,OFFSET:this._PAGINATION_OFFSET}}setPagination(t,e){this._PAGINATION_PAGE=Math.abs((isNaN(t)?1:parseInt(t))-1),this._PAGINATION_SIZE=isNaN(e)?5:parseInt(e),this._PAGINATION_OFFSET=this._PAGINATION_PAGE*this._PAGINATION_SIZE}doSettingWhere(t){let e="";return-1!==t.indexOf("*")&&(e=t.replace("*","%").replace("*","%").replace("*","%"),e={[Op.like]:e}),e}doSettingOrder(t,e){var e=e.split("_"),s="A"===e[1]?"ASC":"DESC";return[t[parseInt(e[0])],s]}doCallProcedure(t){const e=this.getORM();return e.query(t)}async getORM(){return this.useORM.getORM()}msDoInicializa(){this._isError=!1,this._RESULT_DB={}}async msDoInitial(){this.msDoInicializa(),this._idusr="",this._idrol="",this._language="ES",this._PAGINATION_PAGE=0,this._PAGINATION_SIZE=0,this._PAGINATION_OFFSET=5,this.WHERE={},this.ORDER=[],this.MODEL_ATTRIBUTES=[],this.MODEL_FILE="",this.MODEL_QUERY="",this.MODEL_CTG_QUERY={}}async msConnectForm(){return await this.msDoInicializa(),!await this.msConnect(this.getConexion())}msIsError(){return this._isError}msSleep(e){return new Promise(t=>{setTimeout(t,e)})}async msSettingGlobal(t=request){t.query.idusr?this._idusr=t.query.idusr:t.body.idusr?this._idusr=t.body.idusr:t.params.idusr&&(this._idusr=t.params.idusr),t.query.idrol?this._idrol=t.query.idrol:t.body.idrol?this._idrol=t.body.idrol:t.params.idrol&&(this._idrol=t.params.idrol),t.query.language?this._language=t.query.language:t.body.language?this._language=t.body.language:t.params.language&&(this._language=t.params.language)}msDoValidResult(t){let e=!0;(this._RESULT_DB=t)&&null!==t&&0!==t.length&&(e=!1),(this._isError=e)&&this.msSet_Message(404,"NO-FOUND")}async _msSettingConnectForm(){return await this.msSettingApp(),!!await this.msConnectForm()||(this.msSet_ErrorOcurrent("_msSettingConnectForm","connect to dataBase"),!1)}isEmpty(t){return 0===Object.keys(t).length}async msFindAllModelCtg(t={}){let e="",s={};""!==(e=""!==this.MODEL_QUERY?this.MODEL_QUERY:this.MODEL_FILE)&&(this.isEmpty(this.MODEL_CTG_QUERY)?this.isEmpty(t)||(s=t):s=this.MODEL_CTG_QUERY,await this.doQueryFindAll(e,s).then(t=>{this.msSet_Message(200,this.msShowMessageRequest(1),t)}))}async _msFindAllModel(e=request){if(await this._msSettingConnectForm()){await this.msSettingAppSearchOrder(e);e=this.getPagination();let t="";""!==(t=""!==this.MODEL_QUERY?this.MODEL_QUERY:this.MODEL_FILE)&&await this.doQueryFindCountAll(t,{attributes:this.MODEL_ATTRIBUTES,where:this.WHERE,order:this.ORDER,limit:e.LIMIT,offset:e.OFFSET}).then(t=>{t=this.doPagination(t);this.msSet_Message(200,this.msShowMessageRequest(1),t)})}}msSet_ErrorOcurrent(t,e,s=500){this._isError=!0,this.setErrorOcurrent(t,e),this.setIdMessage(s,e,null,this._isError)}msSet_Message(t,e,s=null,r=!1){this.setIdMessage(t,e,s,r)}msSet_Path(t){this._path=t}msSearchDaoJson(e,s){let r=null;return Object.keys(e).forEach(t=>{t==s&&(r=e[s])}),r}async msSettingFindAll(t=request){var{page:e,size:s}=t.query;await this.setPagination(e,s),await this._msFindAllModel(t)}msCodigo(r){if(null==r)return"";const i=this._kNumeral.base42;let t=r.length-1,a=t,o="";for(;0<=a;){let t=r.charAt(a).toUpperCase(),e=i.indexOf(t),s=e.toString(16);a--,s=s.length<2?"0".concat(s):s,o=o.concat(s)}if(o.length<30){let t=30-o.length+1,s=i.substring(1,t);for(a=s.length;0<=a;){let t=s.charAt(a).toUpperCase(),e=i.indexOf(t);a--,o=o.concat(e.toString(16))}}return(o=o.substring(0,30).toUpperCase()).substring(15).concat(o.substring(0,15))}msFill(t,e,s="0"){let r=t.toString().length,i=NaN!==t?t:Math.abs(t);return e<=r?t<0?"-"+i.toString():i.toString():t<0?"-"+s.repeat(e-r)+i.toString():s.repeat(e-r)+i.toString()}msGetLanguage(){return this._language}msGetIdLanguage(){return"EN"===this.msGetLanguage()?1:0}async msGetLogDate(){return this.msLogDate(this._idusr,this._idrol)}msLogDate(t,e){let s=this.msFill(t,8).concat("_").concat(this.msFill(e,3)).concat("_"),r=new Date,i=r.getDate(),a=r.getMonth()+1,o=r.getFullYear(),n=r.getHours(),h=r.getMinutes(),c=r.getSeconds();return i=i<10?"0".concat(i):i,a=a<10?"0".concat(a):a,n=n<10?"0".concat(n):n,h=h<10?"0".concat(h):h,c=c<10?"0".concat(c):c,o="".concat(o).concat(a).concat(i).concat("T").concat(n).concat(h).concat(c),s=s.concat(o).concat("+0600")}msCreateName(){let t=new Date,e=t.getDate(),s=t.getMonth()+1,r=t.getFullYear(),i=t.getHours(),a=t.getMinutes(),o=t.getSeconds();return e=e<10?"0".concat(e):e,s=s<10?"0".concat(s):s,i=i<10?"0".concat(i):i,a=a<10?"0".concat(a):a,o=o<10?"0".concat(o):o,"".concat(r).concat(s).concat(e).concat(i).concat(a).concat(o)}msShowMessageRequest(t){return this.LST_MSG_REQUEST?0===this.LST_MSG_REQUEST.length?"EMPTY MESSAGE LIST":this.LST_MSG_REQUEST[t][this.msGetIdLanguage()]:"MESSAGE LIST DOES NOT EXIST"}}module.exports={token:middlewares,ServiceInterface:ServiceInterface};
